@using SBS_Ecommerce.Models.Base
@{
    ViewBag.Title = "Menu Manager";
    Layout = "~/Views/Admin/_LayoutAdmin.cshtml";
    var lstMenu = (List<Menu>)ViewBag.LstMenu;
    var lstId = "";
    foreach (var item in lstMenu)
    {
        if (item != lstMenu.Last())
        {
            lstId = lstId + item.ID + '_';
        }
        else
        {
            lstId = lstId + item.ID;
        }
    }
}

<link href="~/Content/Admin/css/menumanager.css" rel="stylesheet" />
<!-- Modal -->
<div id="successModal" class="modal fade" role="dialog">
    <div class="modal-dialog" style="left: auto;">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <strong>Success!</strong> <span id="contentAlert"> Front end website has been created menu.</span>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="errorModal" class="modal fade" role="dialog">
    <div class="modal-dialog" style="left: auto;">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Error!</strong> <span id="contentAlert">Url and Label can not null.</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="addChildMenuModal" class="modal fade" role="dialog">
    <div class="modal-dialog" style="left: auto;">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3>Add child to Menu</h3>
            </div>
            <div class="custom-item" style="margin-left: 14px;">
                <span>Url: &nbsp;</span><input id="txtChildUrl" type="text" style="padding:5px 10px" />
            </div>
            <div class="custom-item">
                <span>Label: &nbsp;</span><input id="txtChildLabel" type="text" style="padding:5px 10px" />
            </div>
            <div class="footer-html">
                <input type="button" value="Cancel" class="btn btn-default" data-dismiss="modal" style="margin-top:10px" />
                <input class="btn btn-success btn-ok" value="Save" type="button" onclick="AddChildMenu()" style="margin-top:10px">
            </div>
        </div>
    </div>
</div>

<div id="editMenuModal" class="modal fade" role="dialog">
    <div class="modal-dialog" style="left: auto;">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3>Edit to Menu</h3>
            </div>
            <div class="custom-item" style="margin-left: 14px;">
                <span>Url: &nbsp;</span><input id="txtUrl" type="text" style="padding:5px 10px" />
            </div>
            <div class="custom-item">
                <span>Label: &nbsp;</span><input id="txtLabel" type="text" style="padding:5px 10px" />
            </div>
            <div class="footer-html">
                <input type="button" value="Cancel" class="btn btn-default" data-dismiss="modal" style="margin-top:10px" />
                <input class="btn btn-success btn-ok" value="Save" type="button" onclick="SaveEditMenu()" style="margin-top:10px">
            </div>
        </div>

    </div>
</div>

<div id="editChildMenuModal" class="modal fade" role="dialog">
    <div class="modal-dialog" style="left: auto;">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h3>Edit to Child Menu</h3>
            </div>
            <div class="custom-item" style="margin-left: 14px;">
                <span>Url: &nbsp;</span><input id="txtChildUrl-Modal" type="text" style="padding:5px 10px" />
            </div>
            <div class="custom-item">
                <span>Label: &nbsp;</span><input id="txtChildLabel-Modal" type="text" style="padding:5px 10px" />
            </div>
            <div class="footer-html">
                <input type="button" value="Cancel" class="btn btn-default" data-dismiss="modal" style="margin-top:10px" />
                <input class="btn btn-success btn-ok" value="Save" type="button" onclick="SaveEditChildMenu()" style="margin-top:10px">
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="confirm-menu" data-id="" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="left:auto">
        <div class="modal-content">
            <div class="modal-header">
                Are you sure delete this menu?
            </div>
            <div class="footer-html">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button class="btn btn-danger btn-ok" onclick="DeleteMenu($('#confirm-menu').attr('data-id'))">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-child-menu" data-id="" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="left:auto">
        <div class="modal-content">
            <div class="modal-header">
                Are you sure delete this child menu?
            </div>
            <div class="footer-html">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button class="btn btn-danger btn-ok" onclick="DeleteChildMenu()">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="main-content">
    <!--+general-chart("classes", "title", "height", "id", "counter value", "counter desc", tools enabled (use true or false))-->
    <div class="row2">
        <div class="col-md-12">
            <div class="panel panel-dark">
                <div class="panel-heading"><h3><a href="#" class="btn btn-primary am-toggle-left-sidebar"><i class="icon s7-menu"></i></a> @ViewBag.Title</h3> </div>
            </div>
        </div>
        <div class="col-md-12">
            <div class="panel panel-default">

                <div class="panel-body">
                    <div class="row2">
                        <div class="col-md-4 col-xs-12">
                            <div class="panel panel-dark panel-borders dark">
                                <div class="panel-heading">
                                    <h3><i class="icon s7-global"></i> Custom Links</h3>
                                </div>
                                <div class="panel-body">
                                    <div>
                                        <label class="control-label-left" style="width: 40px; margin-bottom: 20px"> Url:</label>
                                        <input id="input-url" placeholder="http://" style="padding:5px 10px" />
                                    </div>
                                    <div>
                                        <label class="control-label-left" style="width: 40px;"> Label:</label>
                                        <input id="input-label" placeholder="Menu Item" style="padding:5px 10px" />
                                    </div>

                                </div>
                                <div class="panel-footer">
                                    <input type="button" class="btn btn-success btn-rc-sm" value="Add to Menu" onclick="AddMenu()" />
                                </div>


                            </div>
                            <div class="panel panel-dark panel-borders dark">
                                <div class="panel-heading">
                                    <h3><i class="icon s7-angle-right-circle"></i> Side Menu</h3>
                                </div>
                                <div class="panel-body">
                                    <div class="column" style="width: 100%">
                                        @foreach (var item in lstMenu)
                                        {
                                            <div class="dragbox" id="@("item" + (item.ID))">

                                                <h2><i class="itemtoggle glyphicon glyphicon-menu-up"></i> @item.Name  <span class="float-right" style="z-index:10"><i title="Add child menu" onclick="AddChildMenuConfirm('@item.ID')" class="glyphicon glyphicon-plus-sign"></i> <i title="Edit to menu" onclick="EditHTML('@item.ID','@item.Name','@item.Href')" class="glyphicon glyphicon-edit"></i> <i title="Remove to menu" class="glyphicon glyphicon-remove-circle" onclick="ConfirmDeactive('@item.ID')"></i></span></h2>
                                                <div class="descrip-widget">
                                                    <div>Drag and Drop to reorder your @item.Name Menu</div>
                                                    @foreach (var itemChild in item.LstChildMenu)
                                                    {
                                                        <div class="child-item">@itemChild.Name <span class="float-right" style="z-index:10;margin:2px;"><i title="Edit to menu" onclick="EditChildMenu('@item.ID','@itemChild.ID','@itemChild.Name','@itemChild.Href')" class="glyphicon glyphicon-edit"></i> <i title="Remove to menu" class="glyphicon glyphicon-remove-circle" onclick="ConfirmDeleteChild('@item.ID','@itemChild.ID')"></i></span></div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                                <div class="panel-footer">
                                    <div class="row2">
                                        <button type="button" class="btn btn-success btn-rc-sm" onclick="SaveDragMenu()"><i class="icon s7-diskette"></i> Save</button>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8 col-xs-12" style="padding-left: 25px;">
                            <iframe id="preview-Iframe" src="@Url.Content("~/Admin/PreViewMenu?id=")+@(lstId)" width="100%" height="400"></iframe>
                        </div>
                    </div>
                    <hr style="clear:both;" />
                    <div id="content-Preview">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $('#successModal').on('click', function () {

        window.location.reload();

    });

    $('.itemtoggle').click(function () {
        $(this).toggleClass('glyphicon-menu-down glyphicon-menu-up');
        $(this).parent().parent().find('.descrip-widget').toggle();
    });

    function SaveDragMenu() {
        var lstID = [];
        $('#Colum-Layout').children().each(function () {
            lstID.push($(this).attr('id').replace('item', ''));
        });

        $.ajax({
            url: '@Url.Action("SaveMenu", "Admin")',
            data: { lstID: lstID },
            type: 'POST',
            success: function (rs) {
                $('#contentAlert').text('Front end website has been updated menu.');
                $('#successModal').modal('show');
            }

        });
    }

    function AddChildMenu() {
        $.ajax({
            url: '@Url.Action("AddChildMenu", "Admin")',
            data: { id: $('#addChildMenuModal').attr('data-id'), url: $('#txtChildUrl').val(), name: $('#txtChildLabel').val() },
            type: 'POST',
            success: function (rs) {
                $('#addChildMenuModal').modal('hide');
                $('#contentAlert').text('Front end website has been created menu.');
                $('#successModal').modal('show');
            }

        });
    }

    function AddChildMenuConfirm(id) {
        $('#addChildMenuModal').attr('data-id', id);
        $('#addChildMenuModal').modal('show');
        //$(el).parent().parent().parent().find('.descrip-widget').append('<div class="child-item">Child Item</div>');
    }

    function EditHTML(id, name, href) {
        $('#editMenuModal').find('#txtUrl').val(href);
        $('#editMenuModal').find('#txtLabel').val(name);
        $('#editMenuModal').attr('data-id', id);
        $('#editMenuModal').modal('show');
    }

    function EditChildMenu(idParent, idChild, name, href) {
        $('#editChildMenuModal').find('#txtChildUrl-Modal').val(href);
        $('#editChildMenuModal').find('#txtChildLabel-Modal').val(name);
        $('#editChildMenuModal').attr('data-parentID', idParent);
        $('#editChildMenuModal').attr('data-childID', idChild);
        $('#editChildMenuModal').modal('show');
    }

    function SaveEditChildMenu() {
        $.ajax({
            url: '@Url.Action("EditChildMenu", "Admin")',
            data: {
                parentID: $('#editChildMenuModal').attr('data-parentID'),
                childrenID: $('#editChildMenuModal').attr('data-childID'),
                url: $('#txtChildUrl-Modal').val(),
                name: $('#txtChildLabel-Modal').val()
            },
            type: 'POST',
            success: function (rs) {
                $('#editChildMenuModal').modal('hide');
                $('#successModal').modal('show');
            }

        });
    }

    function ConfirmDeactive(id) {
        $('#confirm-menu').attr('data-id', id);
        $('#confirm-menu').modal('show');
    }

    function ConfirmDeleteChild(parentID, childID) {
        $('#confirm-child-menu').attr('data-parentID', parentID);
        $('#confirm-child-menu').attr('data-childID', childID);
        $('#confirm-child-menu').modal('show');
    }

    function DeleteChildMenu() {
        $.ajax({
            url: '@Url.Action("DeleteChildMenu", "Admin")',
            data: { parentID: $('#confirm-child-menu').attr('data-parentID'), childrenID: $('#confirm-child-menu').attr('data-childID') },
            type: 'POST',
            success: function (rs) {
                $('#confirm-child-menu').modal('hide');
                $('#successModal').modal('show');
            }

        });
    }

    function DeleteMenu(id) {
        $.ajax({
            url: '@Url.Action("DeleteMenu", "Admin")',
            data: { id: id },
            type: 'POST',
            success: function (rs) {
                $('#confirm-menu').modal('hide');
                $('#successModal').modal('show');
            }

        });
    }

    function SaveEditMenu() {
        $.ajax({
            url: '@Url.Action("EditMenu", "Admin")',
            data: { id: $('#editMenuModal').attr('data-id'), url: $('#editMenuModal').find('#txtUrl').val(), name: $('#editMenuModal').find('#txtLabel').val() },
            type: 'POST',
            success: function (rs) {
                $('#editMenuModal').modal('hide');
                $('#successModal').modal('show');
            }

        });
    }

    function AddMenu() {
        if ($('#input-label').val() != "" && $('#input-url').val() != "") {
            $.ajax({
                url: '@Url.Action("AddMenu", "Admin")',
                data: { name: $('#input-label').val(), url: $('#input-url').val() },
                type: 'POST',
                success: function (rs) {
                    $('#successModal').modal('show');
                }

            });
        }
        else {
            $('#errorModal').modal('show');
        }
    }

    $(function () {
        $('.dragbox')
        .each(function () {
            $(this).hover(function () {
                //  $(this).find('h2').addClass('collapse');
            }, function () {
                //  $(this).find('h2').removeClass('collapse');
            })
            .find('h2').hover(function () {
                // $(this).find('.configure').css('visibility', 'visible');
            }, function () {
                //  $(this).find('.configure').css('visibility', 'hidden');
            })
            .click(function () {
                $(this).siblings('.dragbox-content').toggle();
            })
            .end()
        });
        $('.column').sortable({
            connectWith: '.column',
            handle: 'h2',
            cursor: 'move',
            placeholder: 'placeholder',
            forcePlaceholderSize: true,
            opacity: 0.4,
            stop: function (event, ui) {
                $(ui.item).find('h2').click();

                var sortorder = '';
                $('.column').each(function () {
                    var itemorder = $(this).sortable('toArray');
                    var columnId = $(this).attr('id');
                    sortorder += columnId + '=' + itemorder.toString() + '&';

                    var lstID = '';
                    $('#Colum-Layout').children('.dragbox').each(function () {
                        //$('#TheForm').append('<input type="hidden" name="id" value=" ' + $(this).attr('id').replace('item', '') + ' " />');
                        lstID = lstID + $(this).attr('id').replace('item', '') + '_';
                    });
                    lstID = lstID.slice(0, -1);
                    $('#preview-Iframe').attr('src', '@Url.Content("~/Admin/PreviewMenu?id=")' + lstID);
                });
                /*Pass sortorder variable to server using ajax to save state*/
            }
        })
        .disableSelection();
    });
</script>